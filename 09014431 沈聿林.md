# 网络高级编程实验报告

09014431 沈聿林

## 实验环境

Ubuntu 16.04 LTS

g++ 5.4.0

## TCP C/S结构程序开发

### 实验要求

> 掌握TCP并发程序设计和C/S结构程序开发

### 实验过程

1. 不修改datetimec.c 客户端程序，将datetimes.c 服务端程序改为并发执行。修改代码如下：

   ```datetimes.c
   #include "datetime.h"
   #include <time.h>

   int main( int argc , char ** argv )
   {
   	int listenfd , connfd;
   	struct sockaddr_in servaddr;
   	char buff[ MAXLINE ];
   	time_t ticks;
   	int pid;

   	listenfd = socket( AF_INET , SOCK_STREAM , 0 );

   	memset( &servaddr , 0 , sizeof( servaddr ) );
   	servaddr.sin_family = AF_INET;
   	servaddr.sin_addr.s_addr = htonl( INADDR_ANY );
   	servaddr.sin_port = htons( 13 );

   	bind( listenfd , (struct sockaddr *)&servaddr , sizeof( servaddr ) );
   	listen( listenfd , 1024 );

   	for( ; ; )
   	{
   		connfd = accept( listenfd , (struct sockaddr *)NULL , NULL );
   		if ((pid = fork()) == 0)
   		{
   			close(listenfd);
   			for (int i = 1; i <= 1000000; ++i)
   			{
   				ticks = time( NULL );
   				snprintf( buff , sizeof( buff ) , "%.24s\r\n" , ctime( &ticks ) );
   				write( connfd , buff , strlen( buff ) );
   			}
   			exit(0);
   		}
   		close( connfd );
   	} 
   }
   ```

2.  执行 `g++ datetimes.c -o datetimes` 编译，并执行`sudo ./datetimes` 运行服务器程序

3.  打开两个terminal，并同时执行`./datetimec 127.0.0.1`，查看是否同时运行

### 实验结果

![2017-05-20 15-36-26屏幕截图](/home/euruson/图片/2017-05-20 15-36-26屏幕截图.png)